<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Sách - BlueBook</title>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/admin/css/QL_sach/quanlysach.css" />
  </head>

  <body>
    <!-- HEADER -->
    <header class="header">
      <a href="/admin/home" class="logo">
        <i class="fa-solid fa-book-open"></i>
        <span>Blue Book</span>
      </a>
    </header>

    <!-- BACK -->
    <div class="container-content">
      <a href="/admin/home" class="back-link">
        <i class="fa-solid fa-arrow-left"></i> Quay về Trang Chủ
      </a>

      <!-- TITLE -->
      <h1 class="page-title">QUẢN LÝ SÁCH</h1>
      <h2 class="page-subtitle">Danh sách Sách</h2>

      <!-- ADD BOOK -->
      <a href="/admin/add_book" class="add-btn">
        <i class="fa-solid fa-plus"></i> Thêm Sách Mới
      </a>

      <!-- BOOK TABLE -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Ảnh</th>
              <th>Mã Sách</th>
              <th>Tên Sách</th>
              <th>Tác Giả</th>
              <th>Thể Loại</th>
              <th>Giá (VNĐ)</th>
              <th>Tồn kho</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody>
            <% for (let i = 0; i < sach.length; i++){ %>
            <tr class="book-row <%= i >= 4 ? 'hidden-row' : '' %>">
              <td>
                <img src="/uploads/<%= sach[i].hinhanh %>" class="img-thumb" />
              </td>
              <td><%= sach[i].masach %></td>
              <td><%= sach[i].tensach %></td>
              <td><%= sach[i].tentacgia %></td>
              <td><%= sach[i].tentheloai %></td>
              <td><%= sach[i].giaban %></td>
              <td><%= sach[i].sl_tonkho %></td>
              <td>
                <a
                  href="/admin/edit_book/<%= sach[i].masach %>"
                  class="action-btn edit"
                >
                  <i class="fa-solid fa-pen"></i> Sửa
                </a>

                <a
                  href="#"
                  class="action-btn delete-btn"
                  data-id="<%= sach[i].masach %>"
                  data-name="<%= sach[i].tensach %>"
                >
                  <i class="fa-solid fa-trash"></i> Xóa
                </a>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>

        <div class="load-more-container">
          <button id="toggle-books" class="add-btn" style="margin-top: 15px">
            Xem thêm ▼
          </button>
        </div>
      </div>

      <!-- THỂ LOẠI -->
      <h1 class="page-title">THỂ LOẠI</h1>

      <a href="/admin/add_theloai" class="add-btn">
        <i class="fa-solid fa-plus"></i> Thêm Thể Loại Mới
      </a>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Mã TL</th>
              <th>Tên Thể loại</th>
              <th>Số lượng sách</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody>
            <% for(let i = 0 ; i < theloai.length; i++){ %>
            <tr>
              <td><%=theloai[i].matheloai%></td>
              <td><%=theloai[i].tentheloai%></td>
              <td><%=theloai[i].soluongsach%></td>
              <td>
                <a
                  href="/admin/edit_theloai/<%=theloai[i].matheloai%>"
                  class="action-btn edit"
                >
                  <i class="fa-solid fa-pen"></i> Sửa
                </a>
                <a
                  href="/admin/delete_theloai/<%=theloai[i].matheloai%>"
                  class="action-btn delete-btn"
                  data-id="<%= theloai[i].matheloai %>"
                  data-name="<%= theloai[i].tentheloai %>"
                >
                  <i class="fa-solid fa-trash"></i> Xóa
                </a>
              </td>
            </tr>
            <% }%>
          </tbody>
        </table>
      </div>

      <!-- TỒN KHO -->
      <h1 class="page-title">THỐNG KÊ TỒN KHO</h1>

<div class="stats-grid">

  <div class="stat-card">
    <div class="stat-part stat-top">
      <h3 class="stat-title">Tổng số lượng sách</h3>
    </div>
    <div class="stat-part stat-middle">
      <span class="stat-value"><%= tongsach.soluong %></span>
    </div>
    <div class="stat-part stat-bottom">
      <p class="stat-desc">Tất cả mã sách</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-part stat-top">
      <h3 class="stat-title">Sách tồn thấp nhất</h3>
    </div>
    <div class="stat-part stat-middle">
      <span class="stat-value">
        <%= sachtonitnhat.tensach %> - <%= sachtonitnhat.sl_tonkho %>
      </span>
    </div>
    <div class="stat-part stat-bottom">
      <p class="stat-desc">Cần nhập thêm</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-part stat-top">
      <h3 class="stat-title">Sách tồn nhiều nhất</h3>
    </div>
    <div class="stat-part stat-middle">
      <span class="stat-value">
        <%= sachtonnhieunhat.tensach %> - <%= sachtonnhieunhat.sl_tonkho %>
      </span>
    </div>
    <div class="stat-part stat-bottom">
      <p class="stat-desc">Có thể giảm giá</p>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-part stat-top">
      <h3 class="stat-title">Thể loại có nhiều sách nhất</h3>
    </div>
    <div class="stat-part stat-middle">
      <span class="stat-value stat-value-small">
        <%= theloainhieusach.tentheloai %>
      </span>
    </div>
    <div class="stat-part stat-bottom">
      <p class="stat-desc">Quan trọng cần theo dõi</p>
    </div>
  </div>

</div>


    <!-- DELETE CONFIRM MODAL -->
    <div id="delete-modal" class="modal">
      <div class="modal-content">
        <h2>Xác nhận xóa</h2>
        <p id="delete-message"></p>

        <div class="modal-buttons">
          <button id="confirm-delete" class="confirm-btn">Xóa</button>
          <button id="cancel-delete" class="cancel-btn">Hủy</button>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script>
      /* NÚT XEM THÊM SÁCH */
      const btn = document.getElementById("toggle-books");
      const hiddenRows = document.querySelectorAll(".hidden-row");
      let expanded = false;

      btn?.addEventListener("click", () => {
        expanded = !expanded;
        hiddenRows.forEach((row) => {
          row.style.display = expanded ? "table-row" : "none";
        });
        btn.textContent = expanded ? "Thu gọn ▲" : "Xem thêm ▼";
      });

      /* MODAL XÓA CHUNG */
      const deleteButtons = document.querySelectorAll(".delete-btn");
      const modal = document.getElementById("delete-modal");
      const msg = document.getElementById("delete-message");
      const confirmBtn = document.getElementById("confirm-delete");
      const cancelBtn = document.getElementById("cancel-delete");
      let deleteUrl = "";

      deleteButtons.forEach((btn) => {
        btn.addEventListener("click", function (e) {
          e.preventDefault();

          const id = this.dataset.id;
          const name = this.dataset.name;

          const isBook = this.closest("table")
            .querySelector("thead th")
            .innerText.trim()
            .includes("Ảnh");

          if (isBook) {
            msg.innerHTML = `Bạn có chắc chắn muốn xóa <b>sách ${name}</b> (Mã ${id})?`;
            deleteUrl = `/admin/delete_book/${id}`;
          } else {
            msg.innerHTML = `Bạn có chắc chắn muốn xóa <b>thể loại ${name}</b> (Mã ${id})?`;
            deleteUrl = `/admin/delete_theloai/${id}`;
          }

          modal.style.display = "flex";
        });
      });

      confirmBtn?.addEventListener("click", () => {
        window.location.href = deleteUrl;
      });

      cancelBtn?.addEventListener("click", () => {
        modal.style.display = "none";
      });

      modal?.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
      });
    </script>
  </body>
</html>
